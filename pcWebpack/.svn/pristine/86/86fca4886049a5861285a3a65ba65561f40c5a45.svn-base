
<template>
  <div class="d-body" style="overflow: hidden;">
    <div id="div-adminTab" v-cloak :class="bgShow ? 'd-mainbg' :''">
      <el-header class="aui-flex-col aui-flex-middle" style="padding:0">
        <el-container class="d-header">
          <el-row class="d-width-100" type="flex" justify="center">
            <el-col :span="2">
              <el-row type="flex" align="middle" style="height:60px">
                <div class>
                  <a href="javascript:;" class="d-disply-inlineBlock">
                    <img src="../../static/Images/logo/logo_inner_blue.png" style="height: 25px;" />
                  </a>
                </div>
              </el-row>
            </el-col>

            <el-col class="d-submenu-top aui-flex-col aui-flex-middle aui-flex-right">
              <el-menu mode="horizontal" :default-active="defaultPage.title2" @select="handleSelect">
                <template v-for="(item,i) in menus">
                  <el-menu-item v-if="item.list == null" :index="item.href" :key="i">
                    <template slot="title">
                      <i class="d-sub-icon" :class="item.icon"></i>
                      <span class="d-tit" slot="title">{{item.name}}</span>
                    </template>
                  </el-menu-item>
                  <el-submenu v-else :index="item.dir" :key="i">
                    <template slot="title">
                      <i class="d-sub-icon" :class="item.icon"></i>
                      <span class="d-tit" slot="title">{{item.name}}</span>
                    </template>
                    <el-menu-item
                      class="el-menu-item"
                      v-for="(li,j) in item.list"
                      :index="li.href"
                      :key="j"
                    >
                      <span>{{li.name}}</span>
                    </el-menu-item>
                  </el-submenu>
                </template>

                <el-submenu index="theme">
                  <template slot="title">
                    <i class="d-sub-icon iconfont icon-theme"></i>
                    <span class="d-tit" slot="title">主题</span>
                  </template>
                  <el-menu-item class="el-menu-item" @click="change(1)">
                    <span>深色</span>
                  </el-menu-item>
                  <el-menu-item class="el-menu-item" @click="change(2)">
                    <span>浅色</span>
                  </el-menu-item>
                </el-submenu>
              </el-menu>
              <div class="d-head-user" style="cursor: pointer" @click="toLogin">
                {{loginUserName}}
                <i class="iconfont icon-signout"></i>
              </div>

              <div class="aui-flex-col aui-flex-middle d-head-weather" @click="jumpWeather">
                <c-weather :items="weatherlist"></c-weather>
              </div>
            </el-col>
          </el-row>
        </el-container>
      </el-header>

      <!--标签Tab-->
      <section
        class="aui-flex-col aui-flex-middle aui-padded-20 aui-padded-b-5 d-tabswitch-con"
        v-if="warnShow"
      >
        <el-row
          type="flex"
          align="center"
          class="aui-margin-t-10 d-width-100"
          style="height: 20px;"
        >
          <el-col :span="6">
            <span
              class="aui-padded-l-25 aui-padded-r-25 aui-padded-t-10 aui-padded-b-10 d-tit-second"
            >{{defaultPage.navTitle}}</span>
          </el-col>
          <el-col :span="8" style="position: relative; right:82px;width:82%;">
            <div style="position: relative;bottom: 14px; width:80%;">
              <c-warning :is-show="warnShow" :notic-list="warnList" @link-to="handleSelect"></c-warning>
            </div>
          </el-col>
        </el-row>
      </section>

      <div class="d-pubContent">
        <div class="aui-padded-20" id="pane">
          <transition name="fade-transform" mode="out-in">
            <router-view :key="key" ref="divBody" />
          </transition>
        </div>
      </div>

      <!--<c-slidebar></c-slidebar>-->
    </div>
  </div>
</template>
		
<script>
import cWeather from "@/components/cWeather";
import cWarning from "@/components/cWarning";

var userInfo = [];

let vmLayout = {
  name: "layout",
  components: { cWarning, cWeather },
  data() {
    return {
      isShow: true,
      defaultPage: {
        title1: "notice",
        title2: "noticeInfo",
        navTitle: "公告 - 公告信息" //导航头
      },
      menus: [],
      tabs: [],
      isCollapse: false,
      loginUserName: jsTools.userNumber(),
      clock: null, //时钟
      weatherlist: [], //天气信息
      warnList: [], //报警信息
      menuClick: 0
    };
  },
  computed: {
    key() {
      return this.$route.path;
    },
    bgShow: function() {
      var ret = this.defaultPage.title2;
      var lis = [
        "Warninglist",
        "warninglist",
        "warningMonitorning",
        "portsMonitorning",
        "notice",
        "dataMonitoring"
      ];
      if (lis.indexOf(ret) >= 0) {
        return true;
      }
      return false;
    },
    footShow: function() {
      var ret = this.defaultPage.title2;
      var lis = [
        "Warninglist",
        "portsMonitorning",
        "noticeInfo",
        "dataMonitoring",
        "vesselAllMonitorning"
      ];

      if (lis.indexOf(ret) >= 0) {
        return false;
      }
      return true;
    },
    warnShow: function() {
      var ret = this.defaultPage.title2;
      var lis = [
        "Warninglist",
        "warninglist",
        "warningMonitorning",
        "noticeInfo"
      ];
      if (lis.indexOf(ret) >= 0) {
        return false;
      }
      return true;
    }
  },

  methods: {
    jumpWeather: function() {
      this.handleSelect(null, ["setting", "weatherSetting"]);
    },
    toLogin: function() {
      jsTools.Alertify.confirm({
        title: "提示",
        message: "是否要退出？",
        callback: function() {
          var a = document.createElement("a");
          a.href = "../index.html";
          a.click();
        }
      });
    },

    sizeInit: function() {
      $("#div-adminTab").css({
        height: window.innerHeight
      });
      $(".mainBody").css({
        width: window.innerWidth
      });
      //中间页面自适应
      $("#pane").css({
        height: window.innerHeight - 105
      });
      window.onresize = function() {
        $("#pane").css({
          height: window.innerHeight - 105
        });
        $("#div-adminTab").css({
          height: window.innerHeight
        });
      };
    },
    handleSelect: function(key, keyPath) {
      if (keyPath == null || keyPath[0] == null) return;
      if (keyPath[1] != "vesselAllMonitorning") {
        sessionStorage.removeItem("fromMap");
        sessionStorage.removeItem("indexClick");
      }
      var curObj = null;
      var powerMenuList = this.menus;

      for (var i in powerMenuList) {
        //针对没有下拉菜单的情况
        if (keyPath.length == 1) {
          if (powerMenuList[i].href == keyPath[0]) {
            curObj = {
              title1: powerMenuList[i].dir,
              title2: keyPath[0],
              navTitle: powerMenuList[i].name,
              buttons: null
            };
            break;
          }
        } else {
          if (powerMenuList[i].dir == keyPath[0]) {
            if (powerMenuList[i].list == null) {
              curObj = {
                title1: keyPath[0],
                title2: keyPath[1],
                navTitle: powerMenuList[i].name,
                buttons: null
              };
              break;
            } else {
              for (var j in powerMenuList[i].list) {
                if (powerMenuList[i].list[j].href == keyPath[1]) {
                  curObj = {
                    title1: keyPath[0],
                    title2: keyPath[1],
                    navTitle:
                      powerMenuList[i].name +
                      " - " +
                      powerMenuList[i].list[j].name,
                    buttons: powerMenuList[i].list[j].buttons
                  };
                  break;
                }
              }
            }
          }
        }
      }
      if (curObj != null) {
        let ret = curObj;
        this.defaultPage = ret;
        jsTools.SessionStorage.setVal("defaultPage", ret);
        //  this.$router.push({name:ret.title2});
        this.$router.push("/" + ret.title1 + "/" + ret.title2);
        jsTools.SessionStorage.setVal("isfromSelect", "false"); //由导航选择进入子页面没有返回按钮
      } else {
        //未找到菜单
        for (var i in powerMenuList) {
          if (powerMenuList[i].href) {
            this.handleSelect(null, [powerMenuList[i].href]);
            return;
          } else {
            this.handleSelect(null, [
              powerMenuList[i].dir,
              powerMenuList[i].list[0].href
            ]);
            return;
          }
        }
      }
    },

    init: function() {
      //初始化,动态设置及创建时钟
      var that = this;
      var ls = jsTools.SessionStorage.getVal("defaultPage");
      if (ls) {
        this.defaultPage = ls;
      }
      this.handleSelect(null, [
        this.defaultPage.title1,
        this.defaultPage.title2
      ]);

     
    },
    getMainWeatherList() {
      var dat = {
        serviceName: jsRes.Server.WeatherQueryService,
        data: {
          Parameter: {
            WeaDateStart: new Date().format("yyyy-MM-dd"),
            WeaDateEnd: new Date().format("yyyy-MM-dd 23:59:59")
          }
        }
      };

      jsTools.ajax(dat, result => {
        this.weatherlist = result.WeatherList;
      });
    },
    getMainWarnInfoList() {
      var dat = {
        serviceName: jsRes.Server.WarnInfoQueryService,
        data: {
          Parameter: {
            DpId: userInfo.isGlobal ? "" : userInfo.Department.DP_ID
          }
        }
      };

      jsTools.ajax(dat, result => {
        result.WarnInfoList.map(function(item) {
          item.content = item.WarnReason;
          item.time = item.WarnStartTime;
        });
        this.warnList = result.WarnInfoList;
      });
    }
  },

  mounted: function() {
    let that = this;
     // 动态拉伸页面初始化
      this.sizeInit();
   
    that.menus = jsRes.adminMenuList;
    getUserInfo(function() {
      userInfo = jsRes.loginUser();

      //权限菜单
      that.menus = jsRes.managerMenu(userInfo);
       that.init();
      that.getMainWeatherList();
      that.getMainWarnInfoList();
    });

    autoRefresh(that);
  }
};

function getUserInfo(callback) {
  var userData = {
    data: {
      Parameter: null,
      ResultModel: {}
    },
    serviceName: jsRes.Server.GetUserInfoService
  };
  jsTools.ajax(userData, function(result) {
    var userInfo = result;

    //获取部门列表
    var dat = {
      serviceName: jsRes.Server.GetBaseDataService,
      data: {
        Parameter: 0
      }
    };

    jsTools.ajax(dat, function(result) {
      //增加部门列表
      userInfo.Deptmentlist = JSON.parse(result);
      //备份传入部门ID
      userInfo.Department.DP_ID_ORA = userInfo.Department.DP_ID;

      //判断当前选中部门是否在下拉列表中
      var dp = Enumerable.From(userInfo.Deptmentlist).FirstOrDefault(
        null,
        "x=>x.DP_ID == " + userInfo.Department.DP_ID
      );
      if (dp == null) {
        userInfo.Department.DP_ID = "";
      }

      //是否是全部权限
      var deptDisable = false;
      if (
        userInfo.Department.DP_ID != "" &&
        !jsTools.Res.Debug &&
        !userInfo.Department.InHeadQuarters
      ) {
        deptDisable = true;
      } else {
        deptDisable = false;
      }
      userInfo.isGlobal = !deptDisable;

      if (userInfo.Department.DP_ID == "") {
        //如果部门为空，则初始化部门为第一个
        userInfo.Department.DP_ID = userInfo.Deptmentlist[0].DP_ID;
      }

      jsTools.SessionStorage.setVal("loginUser", userInfo);

      callback();
    });
  });
}

function autoRefresh(ret) {
  setInterval(function() {
    ret.getMainWeatherList();
    ret.getMainWarnInfoList();

    if (
      ret.defaultPage.title1 == "monitoring" ||
      ret.defaultPage.title2 == "dataMonitoring" ||
      ret.defaultPage.title1 == "warning"
    ) {
      try {
        ret.$refs.divBody.initData();
      } catch (e) {}
    }
  }, 10 * 1000);
}

export default vmLayout;
</script>

<style scoped>
#pane {
  box-sizing: border-box;
}

.d-themechange {
  color: #fff;
  width: 200px;
  position: relative;
  top: 23px;
}

.d-themechange a {
  color: #fff;
  margin-right: 10px;
}

.d-themechange a:hover {
  color: aqua;
}
.d-pubContent {
  box-sizing: border-box;
}
</style>
